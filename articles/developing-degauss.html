<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="dht">
<title>Developing a New DeGAUSS Container • dht</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Developing a New DeGAUSS Container">
<meta property="og:description" content="dht">
<meta property="og:image" content="http://degauss.org/dht/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">dht</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/calling-degauss-from-R.html">Calling DeGAUSS from R</a>
    <a class="dropdown-item" href="../articles/degauss-metadata-specification.html">DeGAUSS Metadata Specifications</a>
    <a class="dropdown-item" href="../articles/developing-degauss.html">Developing a New DeGAUSS Container</a>
    <a class="dropdown-item" href="../articles/helper-functions.html">Helper Functions</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/degauss-org/dht/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="developing-degauss_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Developing a New DeGAUSS Container</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/degauss-org/dht/blob/HEAD/vignettes/developing-degauss.Rmd" class="external-link"><code>vignettes/developing-degauss.Rmd</code></a></small>
      <div class="d-none name"><code>developing-degauss.Rmd</code></div>
    </div>

    
    
<p>The following guide is a step-by-step instruction manual for developing a <a href="https://degauss.org" class="external-link">DeGAUSS</a> container using tools available in the <a href="https://degauss.org/dht" class="external-link"><code>dht</code> R package</a>.</p>
<div class="section level2">
<h2 id="creating-all-files-needed">Creating all files needed<a class="anchor" aria-label="anchor" href="#creating-all-files-needed"></a>
</h2>
<p>Within an empty directory, use <code><a href="../reference/use_degauss_container.html">dht::use_degauss_container()</a></code> to create all of the files needed for a DeGAUSS container. Note that the name of this initially empty directory will be used as the name of the geomarker in the documentation, code, and image repository; it is a good idea to only use lower case letters and underscores (e.g., <code>census_block_group</code>) to comply with container naming conventions.</p>
<p>Most of the added files will <em>usually</em> not need to be edited:</p>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<tbody>
<tr class="odd">
<td align="right"><code>Makefile</code></td>
<td align="left">see <a href="#using-make-for-interactive-development"><code>Make</code> targets</a>
</td>
</tr>
<tr class="even">
<td align="right"><code>test/my_address_file_geocoded.csv</code></td>
<td align="left">test input data file</td>
</tr>
<tr class="odd">
<td align="right"><code>LICENSE.md</code></td>
<td align="left">GPL license</td>
</tr>
<tr class="even">
<td align="right"><code>.github/workflows/build-deploy-pr.yaml</code></td>
<td align="left">GitHub Actions continuous integration for pull requests</td>
</tr>
<tr class="odd">
<td align="right"><code>.github/workflows/build-deploy-release.yaml</code></td>
<td align="left">GitHub Actions continuous integration for releases</td>
</tr>
<tr class="even">
<td align="right"><code>.dockerignore</code></td>
<td align="left">edit to include files other than entrypoint.R in the image</td>
</tr>
</tbody>
</table>
<p>However, some files <strong>must</strong> be edited:</p>
<table class="table"><tbody>
<tr class="odd">
<td align="right"><code>Dockerfile</code></td>
<td align="left">
<code>degauss_description</code> environment variable</td>
</tr>
<tr class="even">
<td align="right"><code>entrypoint.R</code></td>
<td align="left">contains R code to be run in the container</td>
</tr>
<tr class="odd">
<td align="right"><code>README.md</code></td>
<td align="left">software documentation and example instructions</td>
</tr>
</tbody></table>
</div>
<div class="section level2">
<h2 id="editing-files-to-add-r-code-and-documentation">Editing files to add R code and documentation<a class="anchor" aria-label="anchor" href="#editing-files-to-add-r-code-and-documentation"></a>
</h2>
<div class="section level3">
<h3 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a>
</h3>
<p>Fill out the “Using”, “Geomarker Methods”, and “Geomarker Data” sections in <code>README.md</code>, as applicable. <em>Make sure that the version in the example call matches the version of the latest released container.</em></p>
<p>Within the <code>Dockerfile</code>, <code>ENV</code> instructions are used to define <a href="./degauss-metadata-specification.html">environment variables that capture metadata</a> about the DeGAUSS container, including the name (<code>degauss_name</code>), version (<code>degauss_version</code>), and a short description (<code>degauss_description</code>). These environment variables will be available to R code running from inside the container and can be used for <code><a href="../reference/greeting.html">dht::greeting()</a></code> as well as other {dht} functions that read and write geomarker data. Outside of a DeGAUSS container, these are also used by <code><a href="../reference/get_degauss_env_dockerfile.html">get_degauss_env_dockerfile()</a></code>, <code><a href="../reference/get_degauss_env_dockerfile.html">get_degauss_env_online()</a></code>, and <code><a href="../reference/get_degauss_core_lib_env.html">get_degauss_core_lib_env()</a></code>.</p>
<p>When creating a new DeGAUSS container, all but <code>degauss_description</code> are automatically defined and this value needs to be edited from</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">ENV</span> degauss_description=<span class="st">"insert short description here that finishes the sentence 'This container returns ...'"</span></span></code></pre></div>
<p>to something specific and short (ideally <em>less than 50 characters</em>) that finishes the sentence “This container returns …”, like</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">ENV</span> degauss_description=<span class="st">"proximity and length of major roads"</span></span></code></pre></div>
<p>When releasing a new version of the DeGAUSS container in the future, the environment variable <code>degauss_version</code> can be edited in the <code>Dockerfile</code> and R code in the container can use it for greetings, writing output files, and other operations that depend on the current version (or name or description). This prevents the need for manually changing the version number in several different locations for each new release.</p>
</div>
<div class="section level3">
<h3 id="using-r-code-and-data-files-inside-the-container">Using R code and data files inside the container<a class="anchor" aria-label="anchor" href="#using-r-code-and-data-files-inside-the-container"></a>
</h3>
<p>Edit <code>entrypoint.R</code> by replacing the example R code with R code that completes the specific task to be performed by the container.</p>
<p>When ready to build the container, run <code><a href="https://rstudio.github.io/renv/reference/init.html" class="external-link">renv::init()</a></code> to initiate the <code>renv</code> framework and create <code>renv.lock</code>. Subsequent builds can update <code>renv.lock</code> by using <code><a href="https://rstudio.github.io/renv/reference/snapshot.html" class="external-link">renv::snapshot()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="adding-required-system-dependencies">Adding required system dependencies<a class="anchor" aria-label="anchor" href="#adding-required-system-dependencies"></a>
</h3>
<p>R packages, especially spatial packages, often depend on external system dependencies. These will need to be installed using <code>RUN</code> instructions in the Dockerfile. For example, the {sf} package for R requires <code>gdal</code> and other programs, each of which require different install processes depending on the operating system. Since these R packages will always be running inside of a Docker container running Ubuntu 20.04, we can use <a href="https://remotes.r-lib.org/reference/system_requirements.html" class="external-link"><code>remotes::system_requirements()</code></a> to get the specific required install instructions for {sf}:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">system_requirements</span><span class="op">(</span><span class="st">"ubuntu-20.04"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="co"># "apt-get install -y libudunits2-dev" "apt-get install -y libssl-dev"</span></span>
<span><span class="co"># "apt-get install -y libgdal-dev"     "apt-get install -y gdal-bin"</span></span>
<span><span class="co"># "apt-get install -y libgeos-dev"     "apt-get install -y libproj-dev"</span></span></code></pre></div>
<p>These system requirements could be translated to <code>RUN</code> instructions for the Dockerfile to make sure they are available before the R packages that require them are installed:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">RUN</span> apt-get update \</span>
<span id="cb4-2"><a href="#cb4-2"></a>    <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install -yqq --no-install-recommends \</span>
<span id="cb4-3"><a href="#cb4-3"></a>    libudunits2-dev \</span>
<span id="cb4-4"><a href="#cb4-4"></a>    libssl-dev \</span>
<span id="cb4-5"><a href="#cb4-5"></a>    libgdal-dev \</span>
<span id="cb4-6"><a href="#cb4-6"></a>    gdal-bin \</span>
<span id="cb4-7"><a href="#cb4-7"></a>    libgeos-dev \</span>
<span id="cb4-8"><a href="#cb4-8"></a>    libproj-dev \</span>
<span id="cb4-9"><a href="#cb4-9"></a>    <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> clean</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="including-files-inside-the-container">Including files inside the container<a class="anchor" aria-label="anchor" href="#including-files-inside-the-container"></a>
</h2>
<p>By default, the container will copy in <code>entrypoint.R</code> and <code>renv.lock</code> for use at runtime and ignore anything else in the working directory to automatically speed up build times and keep containers smaller in size. If the container requires any other files (e.g., <code>.rds</code> datafiles), edit <code>Dockerfile</code> and <code>.dockerignore</code> so that the files are copied to the container and not ignored by Docker. For example, if we want to use <code>geomarker_data.rds</code>, we would make the following changes in <code>Dockerfile</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a>    <span class="ex">COPY</span> entrypoint.R .</span>
<span id="cb5-2"><a href="#cb5-2"></a>    <span class="ex">COPY</span> geomarker_data.rds    <span class="co"># copy .rds file from host to container when building</span></span></code></pre></div>
<p>and in <code>.dockerignore</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a>    <span class="co"># ignore everything</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>    <span class="ex">**</span></span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="co"># except what we need</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>    !<span class="ex">/renv.lock</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>    !<span class="ex">/entrypoint.R</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>    !<span class="ex">/geomarker_data.rds</span>      <span class="co"># make sure the .rds file is not ignored</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tests">Tests<a class="anchor" aria-label="anchor" href="#tests"></a>
</h2>
<p>A <code>test</code> directory is added with an example geocoded address file (<code>test/my_address_file_geocoded.csv</code>) and is useful for interactive development and automated testing (see below).</p>
</div>
<div class="section level2">
<h2 id="using-make-for-interactive-development">Using <code>make</code> for interactive development<a class="anchor" aria-label="anchor" href="#using-make-for-interactive-development"></a>
</h2>
<p>The <code>Makefile</code> defines several useful <code>make</code> targets that can be useful when locally developing and testing:</p>
<ul>
<li>
<code>make build</code> will build the current DeGAUSS image and name it</li>
<li>
<code>make test</code> will run the container on the included example geocoded CSV file</li>
<li>
<code>make shell</code> will run a DeGAUSS command, but start an interactive shell inside the container for debugging</li>
<li>
<code>make clean</code> is equivalent to <code>docker system prune -f</code>, which cleans up any stopped containers or dangling image layers</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Erika Rasnick, Cole Brokamp.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
